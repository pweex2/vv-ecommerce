version: "3.9"

services:
  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
    container_name: api-gateway
    ports:
      - "8000:8000"
    environment:
      - SERVER_PORT=8000
      - ORDER_SERVICE_URL=http://order-service:${ORDER_PORT}
      - INVENTORY_SERVICE_URL=http://inventory-service:${INVENTORY_PORT}
      - PAYMENT_SERVICE_URL=http://payment-service:${PAYMENT_PORT}
    depends_on:
      - order-service
      - inventory-service
      - payment-service

  order-service:
    build:
      context: .
      dockerfile: services/order-service/Dockerfile
    container_name: order-service
    ports:
      - "${ORDER_PORT}:${ORDER_PORT}"
    environment:
      - SERVER_PORT=${ORDER_PORT}
      # Point to host machine's localhost (local-infra)
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
      - REDIS_HOST=${REDIS_HOST}
      # Service Discovery (Docker DNS)
      - INVENTORY_SERVICE_URL=http://inventory-service:${INVENTORY_PORT}
      - PAYMENT_SERVICE_URL=http://payment-service:${PAYMENT_PORT}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - inventory-service
      - payment-service

  inventory-service:
    build:
      context: .
      dockerfile: services/inventory-service/Dockerfile
    container_name: inventory-service
    ports:
      - "${INVENTORY_PORT}:${INVENTORY_PORT}"
    environment:
      - SERVER_PORT=${INVENTORY_PORT}
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
      - REDIS_HOST=${REDIS_HOST}
    extra_hosts:
      - "host.docker.internal:host-gateway"

  payment-service:
    build:
      context: .
      dockerfile: services/payment-service/Dockerfile
    container_name: payment-service
    ports:
      - "${PAYMENT_PORT}:${PAYMENT_PORT}"
    environment:
      - SERVER_PORT=${PAYMENT_PORT}
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
    extra_hosts:
      - "host.docker.internal:host-gateway"
