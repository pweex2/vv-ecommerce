version: "3.9"

services:
  # --- Infrastructure ---
  mysql:
    image: mysql:8.0
    container_name: vv-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    ports:
      - "${MYSQL_PORT}:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./deploy/init/mysql:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      timeout: 20s
      retries: 10

  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: vv-rabbitmq
    ports:
      - "${RABBITMQ_PORT}:5672"
      - "${RABBITMQ_UI_PORT}:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    restart: always
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 30s
      retries: 3

  redis:
    image: redis:7
    container_name: vv-redis
    ports:
      - "${REDIS_PORT}:6379"
    restart: always

  # --- Application Services ---
  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
    container_name: api-gateway
    ports:
      - "${API_GATEWAY_PORT}:8000"
    environment:
      - SERVER_PORT=8000
      - ORDER_SERVICE_URL=http://order-service:${ORDER_SERVICE_PORT}
      - INVENTORY_SERVICE_URL=http://inventory-service:${INVENTORY_SERVICE_PORT}
      - PAYMENT_SERVICE_URL=http://payment-service:${PAYMENT_SERVICE_PORT}
    depends_on:
      - order-service
      - inventory-service
      - payment-service

  order-service:
    build:
      context: .
      dockerfile: services/order-service/Dockerfile
    container_name: order-service
    # Uncomment ports to expose for local debugging if needed
    # ports:
    #   - "${ORDER_SERVICE_PORT}:${ORDER_SERVICE_PORT}"
    environment:
      - SERVER_PORT=${ORDER_SERVICE_PORT}
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=3306
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - DATABASE_DBNAME=order_db
      - REDIS_ADDR=${REDIS_HOST}:6379
      - MQ_HOST=${MQ_HOST}
      - MQ_PORT=5672
      - INVENTORY_SERVICE_URL=http://inventory-service:${INVENTORY_SERVICE_PORT}
      - PAYMENT_SERVICE_URL=http://payment-service:${PAYMENT_SERVICE_PORT}
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_started
      inventory-service:
        condition: service_started
      payment-service:
        condition: service_started

  inventory-service:
    build:
      context: .
      dockerfile: services/inventory-service/Dockerfile
    container_name: inventory-service
    # Uncomment ports to expose for local debugging if needed
    # ports:
    #   - "${INVENTORY_SERVICE_PORT}:${INVENTORY_SERVICE_PORT}"
    environment:
      - SERVER_PORT=${INVENTORY_SERVICE_PORT}
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=3306
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - DATABASE_DBNAME=inventory_db
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=6379
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started

  payment-service:
    build:
      context: .
      dockerfile: services/payment-service/Dockerfile
    container_name: payment-service
    # Uncomment ports to expose for local debugging if needed
    # ports:
    #   - "${PAYMENT_SERVICE_PORT}:${PAYMENT_SERVICE_PORT}"
    environment:
      - SERVER_PORT=${PAYMENT_SERVICE_PORT}
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=3306
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - DATABASE_DBNAME=payment_db
    depends_on:
      mysql:
        condition: service_healthy

volumes:
  mysql-data:
